<div class="grid grid-cols-1 md:grid-cols-[auto_1fr] gap-6 items-start">
  @if (!readonly()) {
    <div class="flex flex-col gap-3 w-full md:w-auto">
      <!-- Uploader -->
      <app-file-uploader
        [label]="label()"
        [description]="description()"
        [variant]="variant()"
        [disabled]="disabled() || hasProcessing() || allItems().length >= maxFiles()"
        accept=".xml,text/xml,application/xml"
        [multiple]="multiple()"
        (filesSelected)="onValidFiles($event)"
      ></app-file-uploader>

      <!-- File Constraints Info -->
      <div class="flex flex-col gap-1 text-xs text-gray-600">
        <div class="flex items-center gap-1.5">
          <i class="pi pi-info-circle text-sky-600"></i>
          <span><strong>Tipos:</strong> Solo archivos XML</span>
        </div>
        <div class="flex items-center gap-1.5">
          <i class="pi pi-info-circle text-sky-600"></i>
          <span><strong>Tamaño máx:</strong> {{ maxSizeMB() }} MB por archivo</span>
        </div>
        @if (maxFiles() > 1) {
          <div class="flex items-center gap-1.5">
            <i class="pi pi-info-circle text-sky-600"></i>
            <span><strong>Límite:</strong> {{ maxFiles() }} archivos máximo</span>
          </div>
        }
      </div>

      <!-- Processing Indicator -->
      @if (hasProcessing()) {
        <div class="mt-1 flex items-center gap-2 text-xs text-sky-700">
          <i class="pi pi-spinner pi-spin text-xs"></i>
          <span>Procesando archivos…</span>
        </div>
      }
    </div>
  }
  <div class="flex flex-col gap-4">
    <!-- PDF Items List -->
    @if (allItems().length > 0) {
      <div class="space-y-2">
        @if (readonly()) {
          <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
            {{ label() }}
          </h4>
          <p class="text-xs text-gray-500 mt-1">
            {{ description() }}
          </p>
        } @else {
          <div class="flex items-center justify-between">
            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
              Archivos procesados
            </h4>
            @if (completed().length > 0) {
              <app-button
                variant="primary"
                size="sm"
                icon="pi pi-download"
                label="Descargar todos ({{ completed().length }})"
                (clicked)="onDownloadAll()"
              />
            }
          </div>
        }

        <!-- PDF Items -->
        @for (item of allItems(); track item.id) {
          <div
            class="flex items-center gap-3 rounded-lg border border-gray-200 bg-gray-50 p-3"
            [ngClass]="{
              'border-sky-200 bg-sky-50': item.status === 'processing',
              'border-emerald-200 bg-emerald-50': item.status === 'success',
              'border-red-200 bg-red-50': item.status === 'error'
            }"
          >
            <!-- Icon -->
            <div
              class="flex h-12 w-12 items-center justify-center rounded border"
              [ngClass]="{
                'bg-sky-100 text-sky-700 border-sky-300': item.status === 'processing',
                'bg-emerald-100 text-emerald-700 border-emerald-300': item.status === 'success',
                'bg-red-100 text-red-700 border-red-300': item.status === 'error',
                'bg-gray-100 text-gray-700 border-gray-300': item.status === 'pending'
              }"
            >
              @if (item.status === 'processing') {
                <i class="pi pi-spinner pi-spin text-lg"></i>
              } @else if (item.status === 'success') {
                <i class="pi pi-file-pdf text-lg"></i>
              } @else if (item.status === 'error') {
                <i class="pi pi-times-circle text-lg"></i>
              } @else {
                <i class="pi pi-clock text-lg"></i>
              }
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0">
              <p class="truncate text-sm font-medium text-gray-900">
                {{ item.originalXmlName }}
              </p>

              @if (item.status === 'pending') {
                <p class="text-xs text-gray-600 flex items-center gap-1">
                  <i class="pi pi-clock text-xs"></i> Esperando…
                </p>
              } @else if (item.status === 'processing') {
                <p class="text-xs text-sky-600 flex items-center gap-1">
                  <i class="pi pi-spinner pi-spin text-xs"></i> Generando PDF…
                </p>
              } @else if (item.status === 'success') {
                <p class="text-xs text-emerald-600 flex items-center gap-1">
                  <i class="pi pi-check-circle text-sm"></i>
                  <span class="font-medium">{{ item.pdfFilename }}</span>
                </p>
              } @else if (item.status === 'error') {
                <p class="text-xs text-red-600">Error: {{ item.error }}</p>
              }

              <p class="mt-0.5 text-[11px]">
                <span
                  class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-medium"
                  [ngClass]="{
                    'bg-gray-100 text-gray-700': item.status === 'pending',
                    'bg-sky-100 text-sky-700': item.status === 'processing',
                    'bg-emerald-100 text-emerald-700': item.status === 'success',
                    'bg-red-100 text-red-700': item.status === 'error'
                  }"
                >
                  {{ getItemStatusLabel(item.status) }}
                </span>
              </p>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2">
              @if (item.status === 'success') {
                <app-button
                  variant="secondary"
                  size="sm"
                  icon="pi pi-external-link"
                  label="Abrir"
                  (clicked)="onOpenPdf(item)"
                />
                <app-button
                  variant="secondary"
                  size="sm"
                  icon="pi pi-download"
                  label="Descargar"
                  (clicked)="onDownloadPdf(item)"
                />
              }

              @if (!readonly()) {
                <app-button
                  variant="secondary"
                  size="sm"
                  icon="pi pi-trash"
                  [disabled]="item.status === 'processing'"
                  (clicked)="onRequestDelete(item)"
                />
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Delete Confirmation Modal -->
  @if (!readonly() && showDeleteConfirmModal()) {
    <div class="fixed inset-0 z-125 bg-black/60 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6 space-y-4">
        <h3 class="text-lg font-semibold text-gray-900">¿Eliminar archivo?</h3>
        <p class="text-sm text-gray-600">Esta acción no se puede deshacer.</p>

        <div class="bg-gray-50 p-4 rounded-lg space-y-2">
          <p class="text-xs text-gray-500 uppercase">Nombre del XML</p>
          <p class="text-sm">{{ getItemNameForDelete() }}</p>
        </div>

        <div class="flex justify-end gap-3">
          <app-button variant="secondary" label="Cancelar" (clicked)="onCancelDelete()" />
          <app-button
            variant="danger"
            label="Eliminar"
            icon="pi pi-trash"
            (clicked)="onConfirmDelete()"
          />
        </div>
      </div>
    </div>
  }
</div>
